import{j as e}from"./jsx-runtime-Ds-gkUgj.js";import{r as p}from"./index-CtvPRVHf.js";import{q as m}from"./queueService-BrJ6LFgm.js";import{a as I}from"./api-D_0F9__f.js";import{L as w}from"./chunk-AYJ5UCUI-CkRdRQ96.js";const W=n=>{if(typeof n=="string"&&n.startsWith("WK"))return n;if(!n)return"WK000";const h=n!=null&&n.includes("-")?n.split("-")[1]:n,o=parseInt(h,10)||0;return`WK${String(o).padStart(3,"0")}`},S=()=>{const[n,h]=p.useState([]),[o,g]=p.useState([]),[j,Q]=p.useState(!0),[x,D]=p.useState(null),f=p.useCallback(async()=>{Q(!0);try{let s,i;try{[s,i]=await Promise.all([m.fetchPendingQueuesWithDetails(),m.fetchCurrentQueuesWithDetails()])}catch{console.log("Detailed endpoints not available, falling back to basic endpoints"),[s,i]=await Promise.all([m.fetchPendingQueues(),m.fetchCurrentQueues()]);const l=s.map(c=>c.id),P=i.map(c=>c.id),y=[...l,...P];if(y.length>0)try{const c=await m.fetchDetailsForMultipleQueues(y);s=s.map(d=>({...d,userData:c[d.id]||{}})),i=i.map(d=>({...d,userData:c[d.id]||{}}))}catch(c){console.error("Failed to fetch queue details in bulk:",c),console.log("Attempting to fetch details individually");const d=s.map(u=>m.fetchQueueDetails(u.id).then(N=>({...u,userData:N})).catch(()=>u)),k=i.map(u=>m.fetchQueueDetails(u.id).then(N=>({...u,userData:N})).catch(()=>u));s=await Promise.all(d),i=await Promise.all(k)}}const r=s.map(t=>{console.log("Queue with details:",t);const l=t.userData||t.details||t.user||{};return{id:t.id||t._id,queueNumber:W(t.queueNumber||t.id),firstName:l.firstName||"Guest",lastName:l.lastName||"",reasonOfVisit:l.reasonOfVisit||l.reason||l.service||"General Inquiry",status:t.status||"pending",timestamp:t.createdAt||t.date||new Date().toISOString()}}),a=i.map(t=>{const l=t.userData||t.details||t.user||{};return{id:t.id||t._id,queueNumber:W(t.queueNumber||t.id),firstName:l.firstName||"Guest",lastName:l.lastName||"",reasonOfVisit:l.reasonOfVisit||l.reason||l.service||"General Inquiry",status:"in-progress",timestamp:t.createdAt||t.date||new Date().toISOString()}});h(r),g(a),D(null)}catch(s){console.error("Error fetching queue data:",s),D("Could not load queue data. Please ensure the server is running."),h([]),g([])}finally{Q(!1)}},[]),b=async(s,i)=>{try{if(await I.patch(`http://localhost:3000/queue/${s}/status`,{status:i}),i==="in-progress"){const r=n.find(a=>a.id===s);r&&(h(a=>a.filter(t=>t.id!==s)),g(a=>[...a,{...r,status:"in-progress"}]))}else if(i==="completed")g(r=>r.filter(a=>a.id!==s));else if(i==="pending"){const r=o.find(a=>a.id===s);r&&(g(a=>a.filter(t=>t.id!==s)),h(a=>[...a,{...r,status:"pending"}]))}console.log(`Queue ${s} updated to ${i}`),f()}catch(r){console.error("Failed to update queue status:",r),alert("Failed to update queue status. Please try again.")}},v=()=>[...n,...o].sort((i,r)=>{const a=parseInt(i.queueNumber.replace("WK",""),10),t=parseInt(r.queueNumber.replace("WK",""),10);return a-t});return p.useEffect(()=>{f();const s=setInterval(f,3e4);return()=>clearInterval(s)},[f]),e.jsxs("div",{className:"admin-walk-in-queue",children:[!j&&!x&&(n.length>0||o.length>0)&&e.jsxs("div",{className:"queue-stats",children:[e.jsxs("div",{className:"queue-stat",children:[e.jsx("span",{className:"queue-stat-value",children:n.length+o.length}),e.jsx("span",{className:"queue-stat-label",children:"Total"})]}),e.jsxs("div",{className:"queue-stat",children:[e.jsx("span",{className:"queue-stat-value",children:n.length}),e.jsx("span",{className:"queue-stat-label",children:"Waiting"})]}),e.jsxs("div",{className:"queue-stat",children:[e.jsx("span",{className:"queue-stat-value",children:o.length}),e.jsx("span",{className:"queue-stat-label",children:"In Progress"})]})]}),e.jsxs("div",{className:"queue-content",children:[j?e.jsxs("div",{className:"queue-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading queue data..."})]}):x?e.jsx("div",{className:"queue-error",children:e.jsx("p",{children:x})}):v().length===0?e.jsxs("div",{className:"queue-empty",children:[e.jsx("p",{children:"No active walk-in queue"}),e.jsx("small",{children:"When citizens create walk-in appointments, they'll appear here."})]}):e.jsxs("div",{className:"queue-list",children:[v().slice(0,5).map(s=>e.jsxs("div",{className:`queue-item ${s.status==="in-progress"?"active-queue":""}`,children:[e.jsxs("div",{className:"queue-top",children:[e.jsx("div",{className:"queue-number",children:s.queueNumber}),e.jsx("div",{className:`queue-status ${s.status}`,children:s.status})]}),e.jsxs("div",{className:"queue-details",children:[e.jsx("div",{className:"queue-name",children:`${s.firstName} ${s.lastName}`}),e.jsx("div",{className:"queue-reason",children:s.reasonOfVisit}),e.jsx("div",{className:"queue-time",children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"queue-actions",children:[s.status==="pending"&&e.jsx("button",{className:"queue-action-btn start",onClick:()=>b(s.id,"in-progress"),"aria-label":"Start serving this client",children:"Start"}),s.status==="in-progress"&&e.jsx("button",{className:"queue-action-btn complete",onClick:()=>b(s.id,"completed"),"aria-label":"Mark this appointment as completed",children:"Complete"})]})]},s.id)),v().length>5&&e.jsx("div",{className:"queue-more-info",children:e.jsxs("p",{children:["+ ",v().length-5," more queued visitors"]})})]}),e.jsx("div",{className:"queue-footer",children:e.jsx(w,{to:"/AdminWalkInQueue",className:"view-all-btn",children:"View All Queues"})})]})]})};S.__docgenInfo={description:"",methods:[],displayName:"WalkInQueueAdmin"};export{S as W};
