import{j as e}from"./jsx-runtime-Ds-gkUgj.js";import{r}from"./index-CtvPRVHf.js";import{u as te}from"./AuthContext-DROsejNy.js";import{a as f}from"./index-xsH4HHeE.js";const U=()=>{const{user:ae,getCurrentUserId:V}=te(),A=V(),[b,C]=r.useState(""),[v,P]=r.useState(""),[g,S]=r.useState(""),[p,F]=r.useState(""),[D,E]=r.useState(""),[I,k]=r.useState(""),[l,B]=r.useState(""),[G,L]=r.useState(""),[_,x]=r.useState(""),[w,n]=r.useState({text:"",type:""}),[a,i]=r.useState({email:!1,phoneNumber:!1,password:!1,username:!1}),[$,M]=r.useState(null),[u,N]=r.useState(!0),[Z,q]=r.useState(!0),[J,y]=r.useState(!1),[K,j]=r.useState(null);r.useEffect(()=>{(async()=>{if(!A){q(!1);return}try{const t=localStorage.getItem("token"),o=(await f.get("http://localhost:3000/auth/profile",{headers:{Authorization:`Bearer ${t}`}})).data;C(o.firstName||""),P(o.lastName||""),S(o.username||""),F(o.email||""),E(o.phoneNumber||"");const d=localStorage.getItem("lastUsernameChange");d&&(M(new Date(d)),Q(new Date(d)))}catch(t){console.error("Error fetching user data:",t),n({text:"Failed to load user data. Please try again.",type:"error"})}finally{q(!1)}})()},[A]);const Q=s=>{if(!s){N(!0);return}const t=30*24*60*60*1e3,o=Date.now()-s.getTime()>t;N(o)},X=async s=>{s.preventDefault(),n({text:"",type:""});const t={firstName:b,lastName:v};a.email||a.phoneNumber||a.username&&u?(a.email&&(t.email=p),a.phoneNumber&&(t.phoneNumber=D),a.username&&u&&(t.username=g),j(t),y(!0)):await z(t)},z=async s=>{var t,c;try{const o=localStorage.getItem("token");s.username&&u&&(localStorage.setItem("lastUsernameChange",new Date().toISOString()),M(new Date),N(!1)),await f.post("http://localhost:3000/auth/update-profile",s,{headers:{Authorization:`Bearer ${o}`}}),n({text:"Profile updated successfully",type:"success"}),i({email:!1,phoneNumber:!1,password:!1,username:!1}),y(!1),x(""),j(null)}catch(o){console.error("Error updating profile:",o),n({text:((c=(t=o.response)==null?void 0:t.data)==null?void 0:c.message)||"Failed to update profile",type:"error"})}},Y=async s=>{s.preventDefault();try{console.log("Attempting to verify password");const t=await f.post("http://localhost:3000/auth/login",{email:p,emailOrUsername:p,username:g,password:_});console.log("Verification response received"),t.data&&t.data.access_token?(console.log("Password verification successful"),await z(K)):(console.log("Password verification failed - unexpected response format"),n({text:"Incorrect password. Please try again.",type:"error"}))}catch(t){console.error("Error verifying password:",t),t.response?(console.log("Error status:",t.response.status),console.log("Error data:",t.response.data),n({text:t.response.data.message||"Incorrect password. Please try again.",type:"error"})):n({text:"Failed to verify password. Please try again.",type:"error"})}},ee=async s=>{var d,T;if(s.preventDefault(),n({text:"",type:""}),l!==G){n({text:"New passwords do not match",type:"error"});return}if(l.length<8){n({text:"New password must be at least 8 characters long",type:"error"});return}const t=/[A-Z]/.test(l),c=/[a-z]/.test(l),o=/\d/.test(l);if(!t||!c||!o){n({text:"Password must contain uppercase, lowercase, and numbers",type:"error"});return}try{const h=localStorage.getItem("token");await f.post("http://localhost:3000/auth/update-profile",{password:l,oldPassword:I},{headers:{Authorization:`Bearer ${h}`}}),n({text:"Password updated successfully",type:"success"}),k(""),B(""),L(""),i({...a,password:!1})}catch(h){console.error("Error changing password:",h),n({text:((T=(d=h.response)==null?void 0:d.data)==null?void 0:T.message)||"Failed to change password. Please check your current password.",type:"error"})}},se=()=>{y(!1),x(""),j(null)},O=()=>{if(!$)return null;const s=30*24*60*60*1e3,t=new Date($.getTime()+s),c=new Date;if(c>=t)return null;const o=t-c;return`${Math.floor(o/(24*60*60*1e3))} days`};return Z?e.jsx("div",{className:"AccountLoaderUAcc",children:"Loading..."}):e.jsxs("div",{className:"AccountUAcc",children:[e.jsx("div",{className:"AccountHeaderUAcc",children:e.jsx("h1",{children:"User Account Settings"})}),e.jsxs("div",{className:"AccountContainerUAcc",children:[w.text&&e.jsx("div",{className:`MessageUAcc ${w.type}`,children:w.text}),J&&e.jsx("div",{className:"PasswordConfirmationOverlayUAcc",children:e.jsxs("div",{className:"PasswordConfirmationDialogUAcc",children:[e.jsx("h3",{children:"Confirm Changes"}),e.jsx("p",{children:"Please enter your password to confirm these changes to your account."}),e.jsxs("form",{className:"DialogFormGroupUAcc",onSubmit:Y,children:[e.jsxs("div",{className:"DialogFormGroupUAcc",children:[e.jsx("label",{className:"DialogLabel",htmlFor:"confirmationPassword",children:"Password*"}),e.jsx("input",{type:"password",id:"confirmationPassword",value:_,onChange:s=>x(s.target.value),autoFocus:!0,required:!0})]}),e.jsxs("div",{className:"DialogActionsUAcc",children:[e.jsx("button",{type:"button",className:"CancelButtonUAcc",onClick:se,children:"Cancel"}),e.jsx("button",{type:"submit",className:"SaveButtonUAcc",children:"Confirm"})]})]})]})}),e.jsxs("form",{onSubmit:X,className:"AccountFormUAcc",children:[e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"firstName",children:"First name"}),e.jsx("input",{type:"text",id:"firstName",value:b,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"lastName",children:"Last name"}),e.jsx("input",{type:"text",id:"lastName",value:v,onChange:s=>P(s.target.value)})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"username",children:"Username"}),e.jsxs("div",{className:"InputWithActionUAcc",children:[e.jsx("input",{type:"text",id:"username",value:g,onChange:s=>S(s.target.value),disabled:!u||!a.username}),a.username?e.jsx("button",{type:"button",onClick:()=>i({...a,username:!1}),className:"CancelButtonUAcc",children:e.jsx("i",{className:"fas fa-times"})}):e.jsx("button",{type:"button",onClick:()=>i({...a,username:!0}),className:"EditButtonUAcc",disabled:!u,children:e.jsx("i",{className:"fas fa-pen"})})]}),!u&&e.jsxs("p",{className:"RestrictionNoteUAcc",children:["Username can only be changed once every 30 days.",O()&&` Time remaining: ${O()}`]})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"email",children:"E-mail"}),e.jsxs("div",{className:"InputWithActionUAcc",children:[e.jsx("input",{type:"email",id:"email",value:p,onChange:s=>F(s.target.value),disabled:!a.email}),a.email?e.jsx("button",{type:"button",onClick:()=>i({...a,email:!1}),className:"CancelButtonUAcc",children:e.jsx("i",{className:"fas fa-times"})}):e.jsx("button",{type:"button",onClick:()=>i({...a,email:!0}),className:"EditButtonUAcc",children:e.jsx("i",{className:"fas fa-pen"})})]})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"phoneNumber",children:"Phone number"}),e.jsxs("div",{className:"InputWithActionUAcc",children:[e.jsx("input",{type:"tel",id:"phoneNumber",value:D,onChange:s=>E(s.target.value),disabled:!a.phoneNumber}),a.phoneNumber?e.jsx("button",{type:"button",onClick:()=>i({...a,phoneNumber:!1}),className:"CancelButtonUAcc",children:e.jsx("i",{className:"fas fa-times"})}):e.jsx("button",{type:"button",onClick:()=>i({...a,phoneNumber:!0}),className:"EditButtonUAcc",children:e.jsx("i",{className:"fas fa-pen"})})]})]}),e.jsx("div",{className:"ActionsUAcc",children:e.jsx("button",{type:"submit",className:"SaveButtonUAcc",children:"Save Changes"})})]}),e.jsxs("div",{className:"PasswordSectionUAcc",children:[e.jsx("h2",{children:"Change Password"}),e.jsx("button",{type:"button",onClick:()=>i({...a,password:!a.password}),className:a.password?"CancelButtonUAcc":"ChangePasswordButtonUAcc",children:a.password?"Cancel":"Change Password"}),a.password&&e.jsxs("form",{onSubmit:ee,className:"PasswordFormUAcc",children:[e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"currentPassword",children:"Current Password*"}),e.jsx("input",{type:"password",id:"currentPassword",value:I,onChange:s=>k(s.target.value),required:!0})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"newPassword",children:"New Password*"}),e.jsx("input",{type:"password",id:"newPassword",value:l,onChange:s=>B(s.target.value),required:!0})]}),e.jsxs("div",{className:"FormGroupUAcc",children:[e.jsx("label",{htmlFor:"confirmPassword",children:"Confirm New Password*"}),e.jsx("input",{type:"password",id:"confirmPassword",value:G,onChange:s=>L(s.target.value),required:!0})]}),e.jsx("div",{className:"ActionsUAcc",children:e.jsx("button",{type:"submit",className:"SaveButtonUAcc",children:"Update Password"})})]})]})]})]})};U.__docgenInfo={description:"",methods:[],displayName:"UserAccount"};const ie={title:"Components/UserAccount",component:U},m=()=>e.jsx(U,{});m.__docgenInfo={description:"",methods:[],displayName:"Default"};var W,R,H;m.parameters={...m.parameters,docs:{...(W=m.parameters)==null?void 0:W.docs,source:{originalSource:"() => <UserAccount />",...(H=(R=m.parameters)==null?void 0:R.docs)==null?void 0:H.source}}};const le=["Default"];export{m as Default,le as __namedExportsOrder,ie as default};
