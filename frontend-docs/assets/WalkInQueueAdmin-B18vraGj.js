import{j as s}from"./jsx-runtime-Ds-gkUgj.js";import{r as g}from"./index-CtvPRVHf.js";import{q as c}from"./queueService-BpOaP1T5.js";import{L as A}from"./chunk-AYJ5UCUI-CkRdRQ96.js";const I=n=>{if(typeof n=="string"&&n.startsWith("WK"))return n;if(!n)return"WK000";const p=n!=null&&n.includes("-")?n.split("-")[1]:n,o=parseInt(p,10)||0;return`WK${String(o).padStart(3,"0")}`},P=()=>{const[n,p]=g.useState([]),[o,f]=g.useState([]),[Q,D]=g.useState(!0),[x,W]=g.useState(null),v=g.useCallback(async()=>{D(!0);try{let e,i;try{[e,i]=await Promise.all([c.fetchPendingQueuesWithDetails(),c.fetchCurrentQueuesWithDetails()])}catch{console.log("Detailed endpoints not available, falling back to basic endpoints"),[e,i]=await Promise.all([c.fetchPendingQueues(),c.fetchCurrentQueues()]);const a=e.map(l=>l.id),d=i.map(l=>l.id),y=[...a,...d];if(y.length>0)try{const l=await c.fetchDetailsForMultipleQueues(y);e=e.map(u=>({...u,userData:l[u.id]||{}})),i=i.map(u=>({...u,userData:l[u.id]||{}}))}catch(l){console.error("Failed to fetch queue details in bulk:",l),console.log("Attempting to fetch details individually");const u=e.map(m=>c.fetchQueueDetails(m.id).then(j=>({...m,userData:j})).catch(()=>m)),b=i.map(m=>c.fetchQueueDetails(m.id).then(j=>({...m,userData:j})).catch(()=>m));e=await Promise.all(u),i=await Promise.all(b)}}const h=e.map(t=>{console.log("Queue with details:",t);const a=t.userData||t.details||t.user||{};return{id:t.id||t._id,queueNumber:I(t.queueNumber||t.id),firstName:a.firstName||"Guest",lastName:a.lastName||"",reasonOfVisit:a.reasonOfVisit||a.reason||a.service||"General Inquiry",status:t.status||"pending",timestamp:t.createdAt||t.date||new Date().toISOString()}}),r=i.map(t=>{const a=t.userData||t.details||t.user||{};return{id:t.id||t._id,queueNumber:I(t.queueNumber||t.id),firstName:a.firstName||"Guest",lastName:a.lastName||"",reasonOfVisit:a.reasonOfVisit||a.reason||a.service||"General Inquiry",status:"in-progress",timestamp:t.createdAt||t.date||new Date().toISOString()}});p(h),f(r),W(null)}catch(e){console.error("Error fetching queue data:",e),W("Could not load queue data. Please ensure the server is running."),p([]),f([])}finally{D(!1)}},[]),k=async(e,i)=>{var h;try{console.log(`Attempting to update queue ${e} to status: ${i}`);const r=parseInt(e,10)||e;if(i==="in-progress"){const t=n.find(a=>a.id===e||a.id===r);t&&(p(a=>a.filter(d=>d.id!==e&&d.id!==r)),f(a=>[...a,{...t,status:"in-progress"}]))}else if(i==="completed")f(t=>t.filter(a=>a.id!==e&&a.id!==r));else if(i==="pending"){const t=o.find(a=>a.id===e||a.id===r);t&&(f(a=>a.filter(d=>d.id!==e&&d.id!==r)),p(a=>[...a,{...t,status:"pending"}]))}await c.updateQueueStatus(r,i),console.log(`Queue status updated successfully: ${e} â†’ ${i}`),setTimeout(()=>v(),500)}catch(r){console.error("Failed to update queue status:",r),console.error("Error details:",((h=r.response)==null?void 0:h.data)||r.message),alert("Failed to update queue status. Please try again."),v()}},N=()=>[...n,...o].sort((i,h)=>{const r=parseInt(i.queueNumber.replace("WK",""),10),t=parseInt(h.queueNumber.replace("WK",""),10);return r-t});return g.useEffect(()=>{console.log("WalkInQueueAdmin: Initial data fetch"),v();const e=setInterval(()=>{console.log("WalkInQueueAdmin: Auto-refreshing queue data"),v()},3e4);return()=>{console.log("WalkInQueueAdmin: Cleanup - clearing interval"),clearInterval(e)}},[v]),s.jsxs("div",{className:"admin-walk-in-queue",children:[!Q&&!x&&(n.length>0||o.length>0)&&s.jsxs("div",{className:"queue-stats",children:[s.jsxs("div",{className:"queue-stat",children:[s.jsx("span",{className:"queue-stat-value",children:n.length+o.length}),s.jsx("span",{className:"queue-stat-label",children:"Total"})]}),s.jsxs("div",{className:"queue-stat",children:[s.jsx("span",{className:"queue-stat-value",children:n.length}),s.jsx("span",{className:"queue-stat-label",children:"Waiting"})]}),s.jsxs("div",{className:"queue-stat",children:[s.jsx("span",{className:"queue-stat-value",children:o.length}),s.jsx("span",{className:"queue-stat-label",children:"In Progress"})]})]}),s.jsxs("div",{className:"queue-content",children:[Q?s.jsxs("div",{className:"queue-loading",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Loading queue data..."})]}):x?s.jsx("div",{className:"queue-error",children:s.jsx("p",{children:x})}):N().length===0?s.jsxs("div",{className:"queue-empty",children:[s.jsx("p",{children:"No active walk-in queue"}),s.jsx("small",{children:"When citizens create walk-in appointments, they'll appear here."})]}):s.jsxs("div",{className:"queue-list",children:[N().slice(0,5).map(e=>s.jsxs("div",{className:`queue-item ${e.status==="in-progress"?"active-queue":""}`,children:[s.jsxs("div",{className:"queue-top",children:[s.jsx("div",{className:"queue-number",children:e.queueNumber}),s.jsx("div",{className:`queue-status ${e.status}`,children:e.status})]}),s.jsxs("div",{className:"queue-details",children:[s.jsx("div",{className:"queue-name",children:`${e.firstName} ${e.lastName}`}),s.jsx("div",{className:"queue-reason",children:e.reasonOfVisit}),s.jsx("div",{className:"queue-time",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s.jsxs("div",{className:"queue-actions",children:[e.status==="pending"&&s.jsx("button",{className:"queue-action-btn start",onClick:()=>k(e.id,"in-progress"),"aria-label":"Start serving this client",children:"Start"}),e.status==="in-progress"&&s.jsx("button",{className:"queue-action-btn complete",onClick:()=>k(e.id,"completed"),"aria-label":"Mark this appointment as completed",children:"Complete"})]})]},e.id)),N().length>5&&s.jsx("div",{className:"queue-more-info",children:s.jsxs("p",{children:["+ ",N().length-5," more queued visitors"]})})]}),s.jsx("div",{className:"queue-footer",children:s.jsx(A,{to:"/AdminWalkInQueue",className:"view-all-btn",children:"View All Queues"})})]})]})};P.__docgenInfo={description:"",methods:[],displayName:"WalkInQueueAdmin"};export{P as W};
